---
title: JS事件循环
date: 2023-08-22 17:19:37
tags: JavaScript
---

参考：[mdn](https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Event_loop)

并发模型与事件循环：**JavaScript有一个基于事件循环的并发模型，事件循环负责执行代码、收集和处理事件以及执行队列中的子任务。**

### 栈
函数调用形成了一个由若干帧组成的栈。

``` JS
function foo (b) {
  const a = 10;
  return a + b + 1;
}

function bar (x) {
  const y = 3;
  return foo(x * y);
}

console.log(bar(7)); // 32
```

当调用bar时，第一个帧被创建并压入栈中，帧中包含了bar的参数和局部变量。当bar调用foo时候，第二个帧被创建并压入栈中，放在第一个帧之上，帧中包含foo的参数和局部变量。当foo执行完毕然后返回时，第二个帧就被弹出栈（此时栈中剩下bar函数的调用帧）。当bar也执行完毕然后返回时，第一个帧也被弹出，栈就被清空了。

### 堆
对象分配在堆中，堆是一个用来表示一大块（通常是非结构化的）内存区域的计算机术语。

### 队列
一个JavaScript运行时包含了一个待处理消息的消息队列。每一个消息都关联着一个用以处理该消息的回调函数。

在事件循环期间的某个时刻，运行时会从最先进入队列的消息开始处理队列中的消息。被处理的消息会被移出队列，并作为输入参数来调用与之关联的函数。正如前面提到的，调用一个函数会为其创建一个新的的栈帧。

函数的处理会一直进行到执行栈再次为空为止；然后事件循环将会处理队列中的下一个消息（如果还有的话）。

### JavaScript任务分为两种，同步任务和异步任务
- 同步任务：在主线程上排队执行的任务，只有上一个任务执行完毕后，才能执行下一个任务。
- 异步任务：不进入主线程，而是放在任务队列，若有多个异步任务，则需要在任务队列中排队等待。

**JavaScript在执行代码时，会将同步的代码按照顺序排在执行栈中，然后依次执行里面的函数。当遇到异步任务时，就将其放入任务队列中，等待当前执行栈所有同步代码执行完成之后，就会从异步任务队列中取出已完成的异步任务的回调并将其放入执行栈中继续执行，如此循环往复，直到执行完所有任务**
**在事件驱动的模式下，至少包含了一个执行循环来检测任务队列中是否有新任务。通过不断循环，去取出异步任务的回调来执行，这个过程就是[事件循环](/interview-notes/2023/08/22/JS事件循环)，每一次循环就是一个事件周期。**

根据任务种类不同，任务分为宏任务队列和微任务队列
宏任务：**script（整体代码）、setTimeout、setInterval、I/O、UI交互事件、setIsetImmediasetImmediate（Node.js环境）**
微任务：**Promise、MutationObserver、process.nextTick（Node.js环境）**
执行情况：
1.JavaScript引擎首先从宏任务队列中取出第一个任务
2.执行完毕后，再将微任务中的所有任务取出，按照顺序分别全部执行，如果在这一步产生新的微任务，也需要执行。也就是说在执行微任务的过程中产生新的微任务并不会推到下一个循环中执行，而是在当前循环中继续执行
3.然后再从宏任务队列中取下一个，执行完毕后，再次讲微任务队列中的全部取出，循环往复，知道两个任务队列中的任务都取完
**也就是说，一次Eventloop循环会处理一个宏任务和所有这次循环中产生的微任务**